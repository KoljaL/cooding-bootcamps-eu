<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="img/favicon-dark.png" rel="icon" />
  <title>Web App Basic - ToDo</title>
  <script>
    document.documentElement.setAttribute('data-theme', window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
  </script>
  <link rel="stylesheet" href="./css/almostclassless.css">
  <link rel="stylesheet" href="./css/layout.css">

  <style>
    * {
      transition: all 0.3s ease-in-out;
    }

    .success {
      border: 1px solid var(--correct) !important;
    }

    .fail {
      border: 1px solid var(--error) !important;
    }

    ul {
      margin: 0;
      padding: 0;
    }

    li {
      list-style: none;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
    }

    .removeItem {
      opacity: 0;
      color: brown;
    }

    li:hover .removeItem {
      opacity: 1;
      color: darkred;
    }

    .addItem form {
      position: relative;
    }

    .addItem .message {
      position: absolute;
      padding: .25rem .5rem;
    }

    .showList label {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .showList button {
      padding: .25rem .35rem;
      border: 1px solid var(--primary);
      border-radius: 5px;
      background: transparent;
      color: var(--secondary);
      font-size: .8rem;
      line-height: .8rem;
      min-height: 1rem;
      margin-right: 1rem;
    }

    .showList button.active {
      background: var(--primary);
      color: var(--secondary);
    }

    section.debug {
      position: absolute;
      top: 2rem;
      right: 3rem;
    }

    .header__message {
      /* transform: translateY(3rem); */
      display: flex;
      align-items: flex-end;
      gap: 1rem;
      flex-direction: row;
    }

    .header__message--success {
      color: var(--correct);
      margin: 0;
    }

    .header__message--error {
      color: var(--error);
      margin: 0;
    }

    select.filterItems {
      min-width: 7rem;
      width: 7rem;
      height: 1.8rem;
      margin: 0;
      padding: .4rem;
      border: 1px solid var(--primary);
      border-radius: 5px;
      background-color: transparent;
      color: var(--secondary);
      font-size: .8rem;
      line-height: .8rem;
      background-size: .8rem;
    }
  </style>
</head>

<body>
  <header>
    <h1>ToDo-List</h1>
    <div class="header__message">
      <p class="header__message--error"></p>
      <p class="header__message--success"></p>
    </div>
    <span class="icons">
      <label class="theme-toggle" title="Toggle theme"></label>
    </span>
  </header>

  <section class="addItem">
    <h2>Add ToDo Item</h2>
    <form>
      <input type="text" placeholder="Add ToDo Item" />
      <button class="addNewItemButton" type="submit">Add</button>
    </form>
    <p class="message"></p>
  </section>

  <section class="showList">
    <h2>ToDo List</h2>

    <p>
      <select class="filterItems">
        <option value="all">All</option>
        <option value="undone">Undone</option>
        <option value="done">Done</option>
      </select>

    </p>
    <ul class="todoList"></ul>
  </section>

  <section class="debug">
    <h2>Debug</h2>
    <button class="debugItems">show Items</button>
    <pre>
      <code id="debug"></code>
    </pre>
  </section>

  <script>
    //  define variables for DOM elements
    const form = document.querySelector('form');
    const addNewItemButton = document.querySelector('.addNewItemButton');
    const input = document.querySelector('input');
    const message = document.querySelector('.message');
    const todoList = document.querySelector('.todoList');
    const debug = document.querySelector('#debug');
    const debugItems = document.querySelector('.debugItems');
    const filterItems = document.querySelector('.filterItems');
    const headerMessageSuccess = document.querySelector('.header__message--success');
    const headerMessageError = document.querySelector('.header__message--error');
    var existingToDoItems
    addNewItemButton.disabled = true;

    // define existing ToDo Items -- OLD WAY
    // existingToDoItems = [
    //   {
    //     id: 'dU83G',
    //     text: 'Learn HTML',
    //     done: true
    //   },
    //   {
    //     id: 'o0sZ3',
    //     text: 'Learn CSS',
    //     done: false
    //   },
    //   {
    //     id: 'dj5ie',
    //     text: 'Learn JavaScript',
    //     done: false
    //   }
    // ];



    // TODO what is the "better" way?
    // fetch('http://localhost:48329/todos')
    //   .then(response => response.json())
    //   .catch(error => console.error('Error:', error))
    //   .then(response => console.log('Success:', response));


    async function getAllTodos() {
      try {

        const response = await fetch('http://localhost:48329/todos');
        const json = await response.json();
        console.log(json);
        // setTimeout(() => { // a test to slow down the connection
        existingToDoItems = json;
        headerMessageSuccess.textContent = 'ToDo Items loaded from server';
        // }, 1000);
      } catch (error) {
        console.error(error);
        headerMessageError.textContent = 'NetworkError';
        if (localStorage.getItem('todo')) {
          existingToDoItems = JSON.parse(localStorage.getItem('todo'));
          headerMessageSuccess.textContent = 'ToDo Items loaded from localStorage';
        } else {
          headerMessageError.textContent = 'ToDo Items could not be loaded';
        }
      }
    }


    //
    // define eventlistener 
    //
    // init
    document.addEventListener('DOMContentLoaded', async function () {
      console.info('Init ToDo App')
      // TODO why does this not work?
      // await getAllTodos()
      //   .then(() => {
      //     createList();
      //     showExistingItems();
      //   });
      await getAllTodos()
      createList();
      showExistingItems();
    });


    filterItems.addEventListener('change', () => {
      createList(filterItems.value);
    });



    //
    // create ToDo list from array, mint the state
    //
    function createList(state = 'all') {
      todoList.innerHTML = '';
      if (state === 'all') {
        existingToDoItems.forEach(function (item) {
          newItemToDOM(item.id, item.text, item.done)
        });
      } else if (state === 'undone') {
        existingToDoItems.forEach(function (item) {
          if (item.done === false) {
            newItemToDOM(item.id, item.text, item.done)
          }
        });
      } else if (state === 'done') {
        existingToDoItems.forEach(function (item) {
          if (item.done === true) {
            newItemToDOM(item.id, item.text, item.done)
          }
        });
      }
      input.focus();
    }


    // 
    // check for duplicates on keyup
    //
    input.addEventListener('keyup', () => {
      existingToDoItems.forEach(item => {
        if (item.text === input.value) {
          addNewItemButton.disabled = true;
          input.classList.add('fail');
          message.textContent = 'ToDo Item already exists';
          setTimeout(function () {
            message.textContent = '';
            input.classList.remove('fail');
          }, 2000);
        } else {
          input.classList.remove('fail');
          addNewItemButton.disabled = false;
        }
      });
    });





    //
    // add new ToDo Item to DOM
    //
    function newItemToDOM(todoID, todoText, done = false) {
      const li = document.createElement('li');
      li.id = todoID;
      const label = document.createElement('label');
      label.textContent = todoText;

      const span = document.createElement('span');
      span.textContent = 'x';
      span.classList = 'removeItem';


      span.addEventListener('click', function (e) {
        console.log(e.target.parentElement.id);
        const id = e.target.parentElement.id;
        const index = existingToDoItems.findIndex(function (item) {
          return item.id === id;
        });
        existingToDoItems.splice(index, 1);
        showExistingItems();
        document.getElementById(id).remove();
      });




      const ckb = document.createElement('input');
      ckb.type = 'checkbox';
      ckb.checked = done;
      ckb.classList = 'slider';
      ckb.addEventListener('change', function (e) {
        const id = e.target.parentElement.parentElement.id;
        const index = existingToDoItems.findIndex(function (item) {
          return item.id === id;
        });
        existingToDoItems[index].done = e.target.checked;
        showExistingItems();
      });
      // concat checkbox and label
      label.insertBefore(ckb, label.firstChild);
      li.appendChild(label);
      li.appendChild(span);
      todoList.appendChild(li);
    }

    //  
    // handle the submit event
    //
    form.addEventListener('submit', function (evt) {
      console.log(evt)
      evt.preventDefault();
      const todoText = input.value.trim();
      const todoID = chrateID();

      if (todoText.length) {
        // remove focus from input field
        input.blur();
        // add new ToDo Item to List
        newItemToDOM(todoID, todoText)
        // handle input field
        input.classList.add('success');
        input.value = '';
        message.textContent = 'Item added';
        setTimeout(function () {
          message.textContent = '';
          input.placeholder = 'Add next ToDo Item';
          input.classList.remove('success');
          input.focus();
        }, 1500);

        // add new ToDo Item to Array
        let newItem = {
          id: todoID,
          text: todoText,
          done: false
        };
        existingToDoItems.push(newItem);
        saveNewItemOnServer(newItem);
        console.log(existingToDoItems);
        showExistingItems()
      }
      // handle empty input field
      else {
        input.classList.add('fail');
        input.value = '';
        message.textContent = 'Please enter a ToDo Item';
        setTimeout(function () {
          message.textContent = '';
          input.classList.remove('fail');
          input.focus();
        }, 1000);
      }
    });




    //
    // SAVE NEW ITEM ON SERVER
    // 
    async function saveNewItemOnServer(data) {
      console.log(data)
      try {
        const response = fetch('http://localhost:48329/todos', {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        })
        const json = await response.json();
        console.log(json);
        // headerMessageSuccess.textContent = 'ToDo Items loaded from server';
      } catch (error) {
        console.error(error);
        headerMessageError.textContent = 'NetworkError';
      }
    }




    // 
    // create ID
    //
    function chrateID() {
      const chars = '0123456789abcdefghiklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXTZ';
      let str = '';
      for (let i = 0; i < 5; i++) {
        str += chars[Math.floor(Math.random() * chars.length)];
      }
      return str;
    }


    //
    // DEBUG show existing items
    //
    debugItems.addEventListener('click', () => {
      showExistingItems();
    });

    function showExistingItems() {
      let todoString = JSON.stringify(existingToDoItems, null, 2);
      window.localStorage.setItem('todo', todoString);
      debug.textContent = todoString
    }


  </script>


  <div class="spacer"></div>
  <footer>
    <p>
      <a target="_blank" class="sourceCode" href="https://github.com/KoljaL/cooding-bootcamps-eu/blob/master/docs/todo.html">Source Code on GitHub</a>
    </p>
  </footer>

  <!-- END OF HTML -->
  <script src="./js/menu.js"></script>
  <script src="./js/toggleTheme.js"></script>

</body>

</html>